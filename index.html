<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flappy Deluxe</title>
<style>
:root{--accent:#ffd166;--muted:#64748b;--ui:#ffffffcc;}
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif;margin:0;padding:0;}
body,html{height:100%;background:linear-gradient(#9be7ff,#bfeaff);overflow:hidden;}
.page{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;flex-direction:column;opacity:0;pointer-events:none;transition:opacity 0.5s;}
.page.active{opacity:1;pointer-events:auto;}
button{padding:12px 24px;margin:8px;font-weight:700;border:none;border-radius:12px;cursor:pointer;transition:transform 0.15s;}
button:hover{transform:scale(1.05);}
.menu-title{font-size:2rem;margin-bottom:16px;color:#fff;text-shadow:0 3px 6px rgba(0,0,0,0.3);}
.card{background:var(--ui);padding:16px;border-radius:12px;display:flex;flex-direction:column;align-items:center;}
#skins .skin{width:64px;height:64px;margin:6px;border-radius:10px;cursor:pointer;display:flex;justify-content:center;align-items:center;border:2px solid transparent;}
#skins .skin.selected{outline:3px solid #fff;}
#themes .theme{width:80px;height:48px;border-radius:8px;margin:6px;cursor:pointer;display:flex;justify-content:center;align-items:center;font-weight:700;color:#111;}
#themes .theme.selected{outline:3px solid #fff;}
#gameCanvas{background:transparent;display:block;margin:auto;border-radius:12px;z-index:1;position:relative;box-shadow:0 8px 30px rgba(11,40,80,0.25);}
#backBtn{position:absolute;top:12px;right:12px;padding:8px 12px;border-radius:8px;background:var(--ui);border:none;cursor:pointer;z-index:4;}
#scoreDisplay{position:absolute;top:12px;left:12px;font-size:20px;font-weight:700;color:#fff;text-shadow:0 2px 4px #000;z-index:4;}
#coinsDisplay{position:absolute;top:12px;left:120px;font-size:20px;font-weight:700;color:#ffd700;text-shadow:0 2px 4px #000;z-index:4;}
#controls{position:absolute;top:12px;right:110px;display:flex;gap:8px;z-index:4;}
.ctrl-btn{padding:8px 10px;border-radius:8px;border:none;background:var(--ui);cursor:pointer;font-weight:700;}
.overlayPaused{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);color:#fff;font-size:28px;font-weight:800;z-index:5;border-radius:12px;}
.coin{fill:gold;stroke:#ffd700;stroke-width:2;}
</style>
</head>
<body>

<!-- Main Menu -->
<div id="menuPage" class="page active">
  <div class="menu-title">Flappy Deluxe</div>
  <div class="card">
    <button id="playBtn">Play</button>
    <button id="skinsBtn">Bird Skins</button>
    <button id="shopBtn">Shop</button>
    <button id="settingsBtn">Settings</button>
    <div style="margin-top:12px;">Difficulty:
      <select id="difficultySelect">
        <option value="easy">Easy</option>
        <option value="medium" selected>Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>
  </div>
</div>

<!-- Skins Page -->
<div id="skinsPage" class="page">
  <div class="menu-title">Choose Bird Skin</div>
  <div class="card" id="skins"></div>
  <button id="skinsBack">Back</button>
</div>

<!-- Shop Page -->
<div id="shopPage" class="page">
  <div class="menu-title">Shop</div>
  <div class="card" id="shopItems"></div>
  <div id="coinTotal" style="margin-top:8px;font-weight:700;color:#ffd700;"></div>
  <button id="shopBack">Back</button>
</div>

<!-- Settings Page -->
<div id="settingsPage" class="page">
  <div class="menu-title">Settings</div>
  <div class="card">
    <div style="margin-bottom:8px;">Background Theme</div>
    <div id="themes"></div>
    <div style="margin-top:12px;">Music <input type="checkbox" id="musicToggle"></div>
    <div style="margin-top:8px;">Volume <input type="range" min="0" max="1" step="0.01" id="volumeSlider"></div>
  </div>
  <button id="settingsBack">Back</button>
</div>

<!-- Game Page -->
<div id="gamePage" class="page">
  <canvas id="gameCanvas" width="800" height="500"></canvas>
  <div id="controls">
    <button id="pauseBtn" class="ctrl-btn">Pause</button>
    <button id="restartBtn" class="ctrl-btn">Restart</button>
  </div>
  <button id="backBtn">Main Menu</button>
  <div id="scoreDisplay">0</div>
  <div id="coinsDisplay">0</div>
  <div id="pauseOverlay" class="overlayPaused" style="display:none;">PAUSED</div>
</div>

<script>
// --- Pages ---
const pages = {
  menu: document.getElementById('menuPage'),
  skins: document.getElementById('skinsPage'),
  shop: document.getElementById('shopPage'),
  settings: document.getElementById('settingsPage'),
  game: document.getElementById('gamePage')
};
function showPage(name){
  Object.values(pages).forEach(p => p.classList.remove('active'));
  pages[name].classList.add('active');
}

// --- Skins & Shop ---
const skinOptions = [
  {id:'yellow',body:'#ffd166',beak:'#ff6b6b',price:0},
  {id:'red',body:'#ff7b9c',beak:'#ffd166',price:10},
  {id:'blue',body:'#5eead4',beak:'#ffd166',price:15},
  {id:'black',body:'#6b7280',beak:'#d1d5db',price:20}
];
const themeOptions = [
  {id:'day',top:'#9be7ff',bottom:'#bfeaff'},
  {id:'sunset',top:'#ffb88c',bottom:'#ffecd2'},
  {id:'night',top:'#0f172a',bottom:'#071230'}
];

let settings = {
  skin: localStorage.getItem('flappy-skin') || 'yellow',
  theme: localStorage.getItem('flappy-theme') || 'day',
  music: localStorage.getItem('flappy-music') === 'true',
  volume: Number(localStorage.getItem('flappy-volume') || 0.8),
  coins: Number(localStorage.getItem('flappy-coins') || 0)
};
let bestScore = Number(localStorage.getItem('flappy-best') || 0);

// --- Menu UI ---
const skinsContainer = document.getElementById('skins');
skinOptions.forEach(s => {
  const b = document.createElement('div');
  b.className='skin'; b.dataset.id = s.id; b.style.background = s.body;
  b.addEventListener('click', () => { 
    if(settings.coins >= s.price){
      settings.skin = s.id; 
      updateUI(); 
      localStorage.setItem('flappy-skin', s.id);
    } else alert('Not enough coins!');
  });
  skinsContainer.appendChild(b);
});

// Shop
const shopContainer = document.getElementById('shopItems');
function updateShop(){
  shopContainer.innerHTML = '';
  skinOptions.forEach(s=>{
    const div = document.createElement('div');
    div.style.margin='6px';
    div.style.cursor='pointer';
    div.style.fontWeight='700';
    div.textContent = `${s.id} - ${s.price} coins`;
    div.style.color = (settings.coins >= s.price)?'#111':'#888';
    div.addEventListener('click', ()=>{
      if(settings.coins >= s.price){
        settings.skin=s.id; settings.coins -= s.price;
        localStorage.setItem('flappy-skin', s.id);
        localStorage.setItem('flappy-coins', settings.coins);
        updateShop(); updateUI();
      } else alert('Not enough coins!');
    });
    shopContainer.appendChild(div);
  });
  document.getElementById('coinTotal').textContent = `Coins: ${settings.coins}`;
}

// Themes
const themesContainer = document.getElementById('themes');
themeOptions.forEach(t => {
  const b = document.createElement('div');
  b.className='theme'; b.dataset.id = t.id;
  b.style.background = `linear-gradient(180deg,${t.top},${t.bottom})`;
  b.textContent = t.id;
  b.addEventListener('click', () => { settings.theme = t.id; updateUI(); localStorage.setItem('flappy-theme', t.id); });
  themesContainer.appendChild(b);
});

const musicToggle = document.getElementById('musicToggle'); musicToggle.checked = settings.music;
const volumeSlider = document.getElementById('volumeSlider'); volumeSlider.value = settings.volume;
musicToggle.addEventListener('change', ()=>{ settings.music = musicToggle.checked; localStorage.setItem('flappy-music', settings.music); });
volumeSlider.addEventListener('input', ()=>{ settings.volume = Number(volumeSlider.value); localStorage.setItem('flappy-volume', settings.volume); });

function updateUI(){
  Array.from(skinsContainer.children).forEach(c => c.classList.toggle('selected', c.dataset.id === settings.skin));
  Array.from(themesContainer.children).forEach(c => c.classList.toggle('selected', c.dataset.id === settings.theme));
  updateShop();
  document.getElementById('coinsDisplay').textContent = settings.coins;
}

// --- Navigation ---
document.getElementById('playBtn').addEventListener('click', ()=>{ showPage('game'); startGame(); });
document.getElementById('skinsBtn').addEventListener('click', ()=>{ showPage('skins'); updateUI(); });
document.getElementById('shopBtn').addEventListener('click', ()=>{ showPage('shop'); updateUI(); });
document.getElementById('settingsBtn').addEventListener('click', ()=>{ showPage('settings'); });
document.getElementById('skinsBack').addEventListener('click', ()=>{ showPage('menu'); });
document.getElementById('shopBack').addEventListener('click', ()=>{ showPage('menu'); });
document.getElementById('settingsBack').addEventListener('click', ()=>{ showPage('menu'); });
document.getElementById('backBtn').addEventListener('click', ()=>{ stopAndExitToMenu(); });

// Difficulty
let difficulty = 'medium';
document.getElementById('difficultySelect').value = difficulty;
document.getElementById('difficultySelect').addEventListener('change', e=>{ difficulty=e.target.value; });

// --- Canvas & Game vars ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const width = canvas.width, height = canvas.height;
let bird, pipes, frameCount, score, running=false, paused=false, animationId=null;
let clouds = [];
for(let i=0;i<8;i++){ clouds.push({x:Math.random()*width, y:Math.random()*height*0.5, speed:0.2+Math.random()*0.3}); }

// Controls
const pauseBtn = document.getElementById('pauseBtn');
const restartBtn = document.getElementById('restartBtn');
const pauseOverlay = document.getElementById('pauseOverlay');
pauseBtn.addEventListener('click', ()=>{ togglePause(); });
restartBtn.addEventListener('click', ()=>{ startGame(); });

// Sound
function beep(freq,len=0.05){
  try{
    const a=new(window.AudioContext||window.webkitAudioContext)();
    const o=a.createOscillator(), g=a.createGain();
    o.connect(g); g.connect(a.destination);
    g.gain.value=settings.volume*0.12;
    o.frequency.value=freq; o.start();
    setTimeout(()=>{ o.stop(); a.close(); }, len*1000);
  }catch(e){}
}

// --- Flap ---
function flap(){
  if(!running){ startGame(); }
  bird.vy = Math.max(bird.vy, -10);
  bird.vy += -8;
  if(bird.vy<-12) bird.vy=-12;
  beep(880,0.045);
}
window.addEventListener('keydown', e=>{if(e.code==='Space'){ e.preventDefault(); flap(); }});
canvas.addEventListener('mousedown', ()=>{ flap(); });
canvas.addEventListener('touchstart', e=>{ e.preventDefault(); flap(); }, {passive:false});

// --- Game lifecycle ---
function resetGame(){
  bird = { x: width/4, y: height/2, vy:0, r:16 };
  pipes = []; frameCount=0; score=0; paused=false;
  document.getElementById('scoreDisplay').textContent = score;
  pauseOverlay.style.display='none';
}

function spawnPipe(){
  let gap = 140, speed=3;
  if(difficulty==='easy'){ gap=180; speed=2.5; }
  if(difficulty==='medium'){ gap=130; speed=3.2; }
  if(difficulty==='hard'){ gap=110; speed=4; }
  const top=50+Math.random()*(height-gap-150);
  pipes.push({x:width, top, gap, passed:false, speed, coin: Math.random()<0.4 });
}

function startGame(){
  if(animationId) cancelAnimationFrame(animationId);
  resetGame(); running=true;
  animationId=requestAnimationFrame(gameLoop);
}

function stopAndExitToMenu(){ running=false; paused=false; if(animationId) cancelAnimationFrame(animationId); showPage('menu'); }

function togglePause(){
  if(!running) return;
  paused=!paused;
  if(paused){ if(animationId) cancelAnimationFrame(animationId); pauseOverlay.style.display='flex'; pauseBtn.textContent='Resume'; }
  else { pauseOverlay.style.display='none'; pauseBtn.textContent='Pause'; animationId=requestAnimationFrame(gameLoop); }
}

function endGame(){
  running=false;
  if(animationId) cancelAnimationFrame(animationId);
  if(score>bestScore){ bestScore=score; localStorage.setItem('flappy-best',bestScore); }
  setTimeout(()=>{ alert(`Game Over!\nScore: ${score}\nBest: ${bestScore}`); showPage('menu'); },80);
}

// Physics
const GRAVITY=0.5; const MAX_FALL=14;

// Challenges tracker
let challengeCollectedCoins=0; let challengeScore10=false; let challengeCoins5=false; let challengeSurvive30=false;
let runStartTime=0;

// Game loop
function gameLoop(){
  if(!running || paused) return;
  frameCount++;

  // Spawn pipes
  if(frameCount%90===0) spawnPipe();

  // Gravity
  bird.vy += GRAVITY; if(bird.vy>MAX_FALL) bird.vy=MAX_FALL; bird.y+=bird.vy;

  // Move pipes & coins
  pipes.forEach(p=>{
    p.x -= p.speed;
    if(!p.passed && p.x + 60 < bird.x){ p.passed=true; score++; document.getElementById('scoreDisplay').textContent=score; beep(660,0.03); }
    if(p.coin && Math.abs(bird.x-(p.x+30))<16 && bird.y > p.top && bird.y < p.top+p.gap){
      settings.coins++; p.coin=false; localStorage.setItem('flappy-coins', settings.coins); updateUI(); challengeCollectedCoins++;
      beep(1000,0.05);
    }
  });
  pipes = pipes.filter(p => p.x>-80);

  // Ground / ceiling / pipe collisions
  if(bird.y+bird.r>height-24 || bird.y-bird.r<0){ endGame(); return; }
  for(const p of pipes){ if(bird.x+bird.r>p.x && bird.x-bird.r<p.x+60){ if(bird.y-bird.r<p.top || bird.y+bird.r>p.top+p.gap){ endGame(); return; } } }

  // Challenges
  const elapsed = (performance.now()-runStartTime)/1000;
  if(!challengeScore10 && score>=10){ settings.coins+=5; challengeScore10=true; alert("Challenge complete: Score 10 → +5 coins"); }
  if(!challengeCoins5 && challengeCollectedCoins>=5){ settings.coins+=5; challengeCoins5=true; alert("Challenge complete: Collect 5 coins → +5 coins"); }
  if(!challengeSurvive30 && elapsed>=30){ settings.coins+=5; challengeSurvive30=true; alert("Challenge complete: Survive 30s → +5 coins"); }
  localStorage.setItem('flappy-coins', settings.coins);
  updateUI();

  draw();
  animationId=requestAnimationFrame(gameLoop);
}

// Draw
function draw(){
  ctx.clearRect(0,0,width,height);

  // background
  const th = themeOptions.find(t=>t.id===settings.theme);
  const g = ctx.createLinearGradient(0,0,0,height); g.addColorStop(0,th.top); g.addColorStop(1,th.bottom); ctx.fillStyle=g; ctx.fillRect(0,0,width,height);

  // clouds
  clouds.forEach(c=>
