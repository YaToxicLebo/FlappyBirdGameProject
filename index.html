<script>
// --- Pages ---
const pages={menu:document.getElementById('menuPage'),skins:document.getElementById('skinsPage'),settings:document.getElementById('settingsPage'),game:document.getElementById('gamePage')};
function showPage(name){Object.values(pages).forEach(p=>p.classList.remove('active'));pages[name].classList.add('active');}

// --- Skins & Themes ---
const skinOptions=[
  {id:'yellow',body:'#ffd166',beak:'#ff6b6b'},
  {id:'red',body:'#ff7b9c',beak:'#ffd166'},
  {id:'blue',body:'#5eead4',beak:'#ffd166'},
  {id:'black',body:'#6b7280',beak:'#d1d5db'}
];
const themeOptions=[
  {id:'day',top:'#9be7ff',bottom:'#bfeaff'},
  {id:'sunset',top:'#ffb88c',bottom:'#ffecd2'},
  {id:'night',top:'#0f172a',bottom:'#071230'}
];
let settings={
  skin: localStorage.getItem('flappy-skin')||'yellow',
  theme: localStorage.getItem('flappy-theme')||'day',
  music: localStorage.getItem('flappy-music')==='true',
  volume: Number(localStorage.getItem('flappy-volume')||0.8)
};
let bestScore=Number(localStorage.getItem('flappy-best')||0);

const skinsContainer=document.getElementById('skins');
skinOptions.forEach(s=>{
  const b=document.createElement('div');
  b.className='skin';b.dataset.id=s.id;b.style.background=s.body;
  b.addEventListener('click',()=>{settings.skin=s.id;updateUI();localStorage.setItem('flappy-skin',s.id);});
  skinsContainer.appendChild(b);
});
const themesContainer=document.getElementById('themes');
themeOptions.forEach(t=>{
  const b=document.createElement('div');
  b.className='theme';b.dataset.id=t.id;
  b.style.background=`linear-gradient(180deg,${t.top},${t.bottom})`;
  b.textContent=t.id;
  b.addEventListener('click',()=>{settings.theme=t.id;updateUI();localStorage.setItem('flappy-theme',t.id);});
  themesContainer.appendChild(b);
});
const musicToggle=document.getElementById('musicToggle');musicToggle.checked=settings.music;
const volumeSlider=document.getElementById('volumeSlider');volumeSlider.value=settings.volume;
musicToggle.addEventListener('change',()=>{settings.music=musicToggle.checked;localStorage.setItem('flappy-music',settings.music);});
volumeSlider.addEventListener('input',()=>{settings.volume=Number(volumeSlider.value);localStorage.setItem('flappy-volume',settings.volume);});
function updateUI(){
  Array.from(skinsContainer.children).forEach(c=>c.classList.toggle('selected',c.dataset.id===settings.skin));
  Array.from(themesContainer.children).forEach(c=>c.classList.toggle('selected',c.dataset.id===settings.theme));
}

// --- Navigation ---
document.getElementById('playBtn').addEventListener('click',()=>{showPage('game'); startGame();});
document.getElementById('skinsBtn').addEventListener('click',()=>{showPage('skins');updateUI();});
document.getElementById('settingsBtn').addEventListener('click',()=>{showPage('settings');});
document.getElementById('skinsBack').addEventListener('click',()=>{showPage('menu');});
document.getElementById('settingsBack').addEventListener('click',()=>{showPage('menu');});
document.getElementById('backBtn').addEventListener('click',()=>{running=false;showPage('menu');});

// --- Game Variables ---
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const width=canvas.width,height=canvas.height;
let bird,pipes,frameCount,running=false,score=0;
let clouds=[];

// --- Clouds ---
for(let i=0;i<8;i++){
  clouds.push({x:Math.random()*width,y:Math.random()*height*0.5,speed:0.2+Math.random()*0.3});
}

// --- Sounds ---
function beep(freq,len=0.05){
  try{
    const a=new(window.AudioContext||window.webkitAudioContext)();
    const o=a.createOscillator();const g=a.createGain();
    o.connect(g);g.connect(a.destination);
    g.gain.value=settings.volume*0.12;
    o.frequency.value=freq;o.start();
    setTimeout(()=>{o.stop();a.close();},len*1000);
  }catch(e){}
}

// --- Controls ---
function flap(){bird.vy=-7;beep(880,0.05);}
window.addEventListener('keydown',e=>{if(e.code==='Space')flap();});
canvas.addEventListener('mousedown',()=>flap());
canvas.addEventListener('touchstart',e=>{e.preventDefault();flap();},{passive:false});

// --- Game Logic ---
function resetGame(){
  bird={x:width/4,y:height/2,vy:0,r:16};
  pipes=[];
  frameCount=0;
  score=0;
  document.getElementById('scoreDisplay').textContent=score;
}

function spawnPipe(){
  const gap=140;
  const top=50+Math.random()*(height-gap-150);
  pipes.push({x:width,top,gap,passed:false});
}

function startGame(){
  resetGame();
  running=true;
  requestAnimationFrame(gameLoop);
}

function gameLoop(){
  if(!running) return;
  frameCount++;
  if(frameCount%90===0) spawnPipe(); // pipes appear more often
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function update(){
  const gravity=0.35;
  bird.vy+=gravity;
  bird.y+=bird.vy;

  // Move pipes
  for(const p of pipes){
    p.x-=3;
    if(!p.passed && p.x+60<bird.x){
      p.passed=true;
      score++;
      document.getElementById('scoreDisplay').textContent=score;
      beep(660,0.03);
    }
  }
  pipes=pipes.filter(p=>p.x>-80);

  // Check collisions
  if(bird.y+bird.r>height-24 || bird.y-bird.r<0){
    endGame();
  }
  for(const p of pipes){
    if(bird.x+bird.r>p.x && bird.x-bird.r<p.x+60){
      if(bird.y-bird.r<p.top || bird.y+bird.r>p.top+p.gap){
        endGame();
      }
    }
  }
}

function endGame(){
  running=false;
  if(score>bestScore){
    bestScore=score;
    localStorage.setItem('flappy-best',score);
  }
  setTimeout(()=>{
    alert(`Game Over!\nScore: ${score}\nBest: ${bestScore}`);
    showPage('menu');
  },100);
}

function draw(){
  ctx.clearRect(0,0,width,height);

  // Background
  const th=themeOptions.find(t=>t.id===settings.theme);
  const g=ctx.createLinearGradient(0,0,0,height);
  g.addColorStop(0,th.top);
  g.addColorStop(1,th.bottom);
  ctx.fillStyle=g;
  ctx.fillRect(0,0,width,height);

  // Clouds
  clouds.forEach(c=>{
    c.x+=c.speed;
    if(c.x>width+100)c.x=-120;
    ctx.beginPath();
    ctx.ellipse(c.x,c.y,50,30,0,0,Math.PI*2);
    ctx.fillStyle='rgba(255,255,255,0.8)';
    ctx.fill();
  });

  // Pipes
  ctx.fillStyle='#2b9a77';
  pipes.forEach(p=>{
    ctx.fillRect(p.x,0,60,p.top);
    ctx.fillRect(p.x,p.top+p.gap,60,height-(p.top+p.gap)-24);
  });

  // Ground
  ctx.fillStyle='#6fcf97';
  ctx.fillRect(0,height-24,width,24);

  // Bird
  const skin=skinOptions.find(s=>s.id===settings.skin);
  ctx.save();
  ctx.translate(bird.x,bird.y);
  ctx.beginPath();
  ctx.ellipse(0,0,bird.r,bird.r*0.85,0,0,Math.PI*2);
  ctx.fillStyle=skin.body;
  ctx.fill();

  // Eye
  ctx.beginPath();
  ctx.arc(-4,-2,3,0,Math.PI*2);
  ctx.fillStyle='#111';
  ctx.fill();

  // Beak
  ctx.beginPath();
  ctx.moveTo(bird.r-2,0);
  ctx.lineTo(bird.r+12,-5);
  ctx.lineTo(bird.r+12,6);
  ctx.closePath();
  ctx.fillStyle=skin.beak;
  ctx.fill();
  ctx.restore();
}

updateUI();
</script>
