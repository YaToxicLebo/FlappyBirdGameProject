<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Deluxe Ultimate</title>
<style>
:root{--accent:#ffd166;--muted:#64748b;--ui:#ffffffcc;}
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif;margin:0;padding:0;}
body,html{height:100%;background:linear-gradient(#9be7ff,#bfeaff);overflow:hidden;}
.page{position:absolute;inset:0;display:flex;justify-content:center;align-items:center;flex-direction:column;opacity:0;pointer-events:none;transition:opacity 0.5s;}
.page.active{opacity:1;pointer-events:auto;}
button{padding:12px 24px;margin:8px;font-weight:700;border:none;border-radius:12px;cursor:pointer;transition:transform 0.15s;}
button:hover{transform:scale(1.05);}
.menu-title{font-size:2rem;margin-bottom:16px;color:#fff;text-shadow:0 3px 6px rgba(0,0,0,0.3);}
.card{background:var(--ui);padding:16px;border-radius:12px;display:flex;flex-direction:column;align-items:center;}
#skins .skin{width:64px;height:64px;margin:6px;border-radius:10px;cursor:pointer;display:flex;justify-content:center;align-items:center;border:2px solid transparent;}
#skins .skin.selected{outline:3px solid #fff;}
#themes .theme{width:80px;height:48px;border-radius:8px;margin:6px;cursor:pointer;display:flex;justify-content:center;align-items:center;font-weight:700;color:#111;}
#themes .theme.selected{outline:3px solid #fff;}
#gameCanvas{background:transparent;display:block;margin:auto;border-radius:12px;z-index:1;position:relative;box-shadow:0 8px 30px rgba(11,40,80,0.25);}
#backBtn{position:absolute;top:12px;right:12px;padding:8px 12px;border-radius:8px;background:var(--ui);border:none;cursor:pointer;z-index:4;}
#scoreDisplay{position:absolute;top:12px;left:12px;font-size:20px;font-weight:700;color:#fff;text-shadow:0 2px 4px #000;z-index:4;}
#coinDisplay{position:absolute;top:40px;left:12px;font-size:18px;font-weight:700;color:gold;text-shadow:0 2px 4px #000;z-index:4;}
#controls{position:absolute;top:12px;right:110px;display:flex;gap:8px;z-index:4;}
.ctrl-btn{padding:8px 10px;border-radius:8px;border:none;background:var(--ui);cursor:pointer;font-weight:700;}
.overlayPaused{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);color:#fff;font-size:28px;font-weight:800;z-index:5;border-radius:12px;}
</style>
</head>
<body>

<!-- Main Menu -->
<div id="menuPage" class="page active">
  <div class="menu-title">Flappy Deluxe</div>
  <div class="card">
    <button id="playBtn">Play</button>
    <button id="skinsBtn">Bird Skins</button>
    <button id="settingsBtn">Settings</button>
    <button id="shopBtn">Shop</button>
  </div>
</div>

<!-- Skins Page -->
<div id="skinsPage" class="page">
  <div class="menu-title">Choose Bird Skin</div>
  <div class="card" id="skins"></div>
  <button id="skinsBack">Back</button>
</div>

<!-- Shop Page -->
<div id="shopPage" class="page">
  <div class="menu-title">Coin Shop</div>
  <div class="card">
    <div>Coins: <span id="shopCoins">0</span></div>
    <button id="buyShield">Buy Shield (50)</button>
    <button id="buyMagnet">Buy Magnet (50)</button>
  </div>
  <button id="shopBack">Back</button>
</div>

<!-- Settings Page -->
<div id="settingsPage" class="page">
  <div class="menu-title">Settings</div>
  <div class="card">
    <div style="margin-bottom:8px;">Background Theme</div>
    <div id="themes"></div>
    <div style="margin-top:12px;">Music <input type="checkbox" id="musicToggle"></div>
    <div style="margin-top:8px;">Volume <input type="range" min="0" max="1" step="0.01" id="volumeSlider"></div>
    <div style="margin-top:8px;">Difficulty 
      <select id="difficultySelect">
        <option value="easy">Easy</option>
        <option value="normal">Normal</option>
        <option value="hard">Hard</option>
      </select>
    </div>
  </div>
  <button id="settingsBack">Back</button>
</div>

<!-- Game Page -->
<div id="gamePage" class="page">
  <canvas id="gameCanvas" width="800" height="500"></canvas>
  <div id="controls">
    <button id="pauseBtn" class="ctrl-btn">Pause</button>
    <button id="restartBtn" class="ctrl-btn">Restart</button>
  </div>
  <button id="backBtn">Main Menu</button>
  <div id="scoreDisplay">0</div>
  <div id="coinDisplay">0</div>
  <div id="pauseOverlay" class="overlayPaused" style="display:none;">PAUSED</div>
</div>

<script>
// --- Pages ---
const pages = {
  menu: document.getElementById('menuPage'),
  skins: document.getElementById('skinsPage'),
  settings: document.getElementById('settingsPage'),
  shop: document.getElementById('shopPage'),
  game: document.getElementById('gamePage')
};
function showPage(name){
  Object.values(pages).forEach(p => p.classList.remove('active'));
  pages[name].classList.add('active');
}

// --- Settings & Skins ---
const skinOptions = [
  {id:'yellow',body:'#ffd166',beak:'#ff6b6b'},
  {id:'red',body:'#ff7b9c',beak:'#ffd166'},
  {id:'blue',body:'#5eead4',beak:'#ffd166'},
  {id:'black',body:'#6b7280',beak:'#d1d5db'}
];
const themeOptions = [
  {id:'day',top:'#9be7ff',bottom:'#bfeaff'},
  {id:'sunset',top:'#ffb88c',bottom:'#ffecd2'},
  {id:'night',top:'#0f172a',bottom:'#071230'}
];
let settings = {
  skin: localStorage.getItem('flappy-skin') || 'yellow',
  theme: localStorage.getItem('flappy-theme') || 'day',
  music: localStorage.getItem('flappy-music')==='true',
  volume: Number(localStorage.getItem('flappy-volume')||0.8),
  difficulty: localStorage.getItem('flappy-difficulty') || 'normal'
};
let bestScore = Number(localStorage.getItem('flappy-best')||0);
let coins = Number(localStorage.getItem('flappy-coins')||0);

// Skins
const skinsContainer = document.getElementById('skins');
skinOptions.forEach(s => {
  const b = document.createElement('div'); b.className='skin'; b.dataset.id=s.id; b.style.background=s.body;
  b.addEventListener('click',()=>{settings.skin=s.id;updateUI(); localStorage.setItem('flappy-skin',s.id);});
  skinsContainer.appendChild(b);
});

// Themes
const themesContainer=document.getElementById('themes');
themeOptions.forEach(t=>{
  const b=document.createElement('div'); b.className='theme'; b.dataset.id=t.id; b.style.background=`linear-gradient(180deg,${t.top},${t.bottom})`; b.textContent=t.id;
  b.addEventListener('click',()=>{settings.theme=t.id;updateUI();localStorage.setItem('flappy-theme',t.id);});
  themesContainer.appendChild(b);
});

// UI updates
function updateUI(){
  Array.from(skinsContainer.children).forEach(c=>c.classList.toggle('selected',c.dataset.id===settings.skin));
  Array.from(themesContainer.children).forEach(c=>c.classList.toggle('selected',c.dataset.id===settings.theme));
  document.getElementById('difficultySelect').value = settings.difficulty;
  document.getElementById('shopCoins').textContent = coins;
  document.getElementById('coinDisplay').textContent = coins;
}

// --- Navigation ---
document.getElementById('playBtn').addEventListener('click',()=>{showPage('game'); startGame();});
document.getElementById('skinsBtn').addEventListener('click',()=>{showPage('skins'); updateUI();});
document.getElementById('settingsBtn').addEventListener('click',()=>{showPage('settings');});
document.getElementById('shopBtn').addEventListener('click',()=>{showPage('shop'); updateUI();});
document.getElementById('skinsBack').addEventListener('click',()=>{showPage('menu');});
document.getElementById('settingsBack').addEventListener('click',()=>{showPage('menu');});
document.getElementById('shopBack').addEventListener('click',()=>{showPage('menu');});
document.getElementById('backBtn').addEventListener('click',()=>{stopAndExitToMenu();});

// --- Settings controls ---
document.getElementById('musicToggle').checked=settings.music;
document.getElementById('musicToggle').addEventListener('change',()=>{settings.music=document.getElementById('musicToggle').checked;localStorage.setItem('flappy-music',settings.music);});
document.getElementById('volumeSlider').value=settings.volume;
document.getElementById('volumeSlider').addEventListener('input',()=>{settings.volume=Number(document.getElementById('volumeSlider').value);localStorage.setItem('flappy-volume',settings.volume);});
document.getElementById('difficultySelect').addEventListener('change',(e)=>{settings.difficulty=e.target.value; localStorage.setItem('flappy-difficulty',settings.difficulty);});

// --- Shop buttons ---
document.getElementById('buyShield').addEventListener('click',()=>{if(coins>=50){coins-=50;alert("Shield purchased!"); localStorage.setItem('flappy-coins',coins);updateUI();}});
document.getElementById('buyMagnet').addEventListener('click',()=>{if(coins>=50){coins-=50;alert("Magnet purchased!"); localStorage.setItem('flappy-coins',coins);updateUI();}});

// --- Canvas ---
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const width=canvas.width, height=canvas.height;
let bird,pipes,frameCount,score,running=false,paused=false;
let clouds=[],animationId=null;
for(let i=0;i<8;i++){clouds.push({x:Math.random()*width,y:Math.random()*height*0.5,speed:0.2+Math.random()*0.3});}

// --- Controls ---
const pauseBtn=document.getElementById('pauseBtn');
const restartBtn=document.getElementById('restartBtn');
const pauseOverlay=document.getElementById('pauseOverlay');
pauseBtn.addEventListener('click',()=>{togglePause();});
restartBtn.addEventListener('click',()=>{startGame();});

// --- Sound ---
function beep(freq,len=0.05){try{const a=new(window.AudioContext||window.webkitAudioContext)();const o=a.createOscillator();const g=a.createGain();o.connect(g);g.connect(a.destination);g.gain.value=settings.volume*0.12;o.frequency.value=freq;o.start();setTimeout(()=>{o.stop();a.close();},len*1000);}catch(e){}}

// --- Game functions ---
const GRAVITY=0.5, MAX_FALL=12;
function flap(){bird.vy=Math.max(bird.vy,-9); bird.vy+=-8;if(bird.vy<-10) bird.vy=-10;beep(880,0.045); if(!running) startGame();}
window.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault(); flap();}});
canvas.addEventListener('mousedown',()=>{flap();});
canvas.addEventListener('touchstart',e=>{e.preventDefault(); flap();},{passive:false});

function resetGame(){
  bird={x:width/4,y:height/2,vy:0,r:16};
  pipes=[]; frameCount=0; score=0;
  document.getElementById('scoreDisplay').textContent=score;
  paused=false; pauseOverlay.style.display='none';
}

// --- Pipe spawn ---
function spawnPipe(){
  const gap = settings.difficulty==='easy'?160:settings.difficulty==='normal'?140:120;
  const top = 50+Math.random()*(height-gap-150);
  pipes.push({x:width,top,gap,passed:false});
}

// --- Game loop ---
function startGame(){if(animationId) cancelAnimationFrame(animationId); resetGame(); running=true; animationId=requestAnimationFrame(gameLoop);}
function stopAndExitToMenu(){running=false; paused=false; if(animationId) cancelAnimationFrame(animationId); showPage('menu');}
function togglePause(){if(!running) return; paused=!paused; if(paused){if(animationId) cancelAnimationFrame(animationId); pauseOverlay.style.display='flex'; pauseBtn.textContent='Resume';} else {pauseOverlay.style.display='none'; pauseBtn.textContent='Pause'; animationId=requestAnimationFrame(gameLoop);}}
function endGame(){running=false; if(animationId) cancelAnimationFrame(animationId); if(score>bestScore){bestScore=score; localStorage.setItem('flappy-best',bestScore);} coins+=Math.floor(score/2); localStorage.setItem('flappy-coins',coins); updateUI(); setTimeout(()=>{alert(`Game Over!\nScore: ${score}\nBest: ${bestScore}\nCoins earned: ${Math.floor(score/2)}`); showPage('menu');},100);}
function gameLoop(){
  if(!running||paused) return;
  frameCount++;
  if(frameCount%90===0) spawnPipe();

  // physics
  bird.vy+=GRAVITY; if(bird.vy>MAX_FALL) bird.vy=MAX_FALL; bird.y+=bird.vy;

  // pipes
  pipes.forEach(p=>{const
